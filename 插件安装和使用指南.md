# Obsidian Omnivore 本地测试插件 - 安装和使用指南

## 📦 插件安装

### 方法一：手动安装（推荐）

1. **下载插件文件**
   - 复制以下三个文件到Obsidian插件目录：
     ```
     obsidian-plug/obsidian-omnivore/main.js
     obsidian-plug/obsidian-omnivore/manifest.json  
     obsidian-plug/obsidian-omnivore/styles.css
     ```

2. **找到Obsidian插件目录**
   - Windows: `%APPDATA%\Obsidian\plugins\`
   - macOS: `~/Library/Application Support/obsidian/plugins/`
   - Linux: `~/.config/obsidian/plugins/`

3. **创建插件文件夹**
   ```bash
   # 在plugins目录下创建
   mkdir obsidian-omnivore-local-test
   ```

4. **复制文件**
   将上述三个文件复制到 `obsidian-omnivore-local-test` 文件夹中

5. **重启Obsidian**
   - 完全关闭Obsidian
   - 重新启动Obsidian

### 方法二：开发者模式安装

1. **启用开发者模式**
   - 打开Obsidian设置
   - 进入"社区插件"页面
   - 关闭安全模式
   - 启用"开发者模式"

2. **直接链接插件目录**
   ```bash
   # 创建软链接（需要管理员权限）
   mklink /D "%APPDATA%\\Obsidian\\plugins\\obsidian-omnivore-local" "C:\\Users\\laizeyang\\OneDrive\\OWN\\笔记同步助手\\gate\\obsidian\\obsidian-plug\\obsidian-omnivore"
   ```

## ⚙️ 本地服务器设置

### 启动Mock服务器

1. **启动服务器**（已完成）
   ```bash
   cd server
   npm start
   ```
   
   服务器将在 `http://localhost:3001` 运行

2. **验证服务器状态**
   - 访问 http://localhost:3001/health 查看健康状态
   - 访问 http://localhost:3001/api/debug/articles 查看Mock数据

### 环境变量设置

**当前插件已内置本地测试配置**，自动检测并使用本地服务器，无需额外设置环境变量。

插件会在控制台显示：
```
🔧 本地测试模式已启用，使用Mock服务器: http://localhost:3001/api/graphql
```

## 🔧 Obsidian中的配置

### 1. 启用插件

1. 打开Obsidian设置（Ctrl/Cmd + ,）
2. 点击左侧"社区插件"
3. 在已安装插件列表中找到"Omnivore"
4. 点击切换按钮启用插件

### 2. 配置插件设置

1. 在"社区插件"页面点击"Omnivore"插件的⚙️设置按钮
2. 配置以下设置：

   **基础设置**：
   - **API Key**: 输入任意值（本地测试不验证）
   - **Endpoint**: 保持默认值（插件会自动重定向到本地服务器）
   - **Sync Filter**: 选择同步范围
     - `ALL` - 同步所有文章
     - `LIBRARY` - 仅同步未归档文章  
     - `ARCHIVED` - 仅同步已归档文章
     - `HIGHLIGHTS` - 仅同步包含高亮的文章

   **文件设置**：
   - **Folder**: 设置文章保存路径，如 `Omnivore/{{{date}}}`
   - **Filename**: 设置文件名格式，如 `{{{title}}}`
   - **Template**: 自定义文章模板（可保持默认）

### 3. 开始同步

1. 点击"Sync"按钮开始同步
2. 查看控制台输出确认使用本地服务器
3. 同步完成后在指定文件夹查看导入的文章

## 📊 测试数据说明

Mock服务器包含10条测试文章：

| 编号 | 标题 | 状态 | 特点 |
|------|------|------|------|
| 1-6  | React Hook最佳实践等 | 已读 | 有阅读进度 |
| 7    | GraphQL实践指南 | 未读 | 库中文章 |
| 8-10 | 微前端架构设计等 | 已归档 | 归档状态 |

**数据特征**：
- 所有文章都包含高亮注释
- 支持不同的文章类型（ARTICLE/FILE/BOOK）
- 包含完整的Markdown内容和代码示例
- 带有标签系统（技术、前端、JavaScript等）

## 🔍 功能测试

### 测试不同的同步过滤器

1. **测试"ALL"过滤器**
   - 设置Filter为"ALL"
   - 应该同步所有10篇文章

2. **测试"LIBRARY"过滤器**  
   - 设置Filter为"LIBRARY"
   - 应该同步前7篇未归档文章

3. **测试"ARCHIVED"过滤器**
   - 设置Filter为"ARCHIVED"  
   - 应该同步后3篇已归档文章

4. **测试"HIGHLIGHTS"过滤器**
   - 设置Filter为"HIGHLIGHTS"
   - 应该同步所有10篇文章（都包含高亮）

### 测试自定义查询

在"Custom Query"字段中输入：
- `updated:2024-01-01T00:00:00.000Z` - 按时间过滤
- `has:highlights` - 包含高亮的文章
- `in:archive` - 仅归档文章

## 🐛 故障排除

### 常见问题

1. **插件未显示**
   - 确认三个文件都已正确复制
   - 检查文件路径是否正确
   - 重启Obsidian

2. **同步失败**
   - 确认Mock服务器正在运行（http://localhost:3001/health）
   - 查看Obsidian控制台（Ctrl+Shift+I）的错误信息
   - 检查是否显示"本地测试模式已启用"消息

3. **无文章导入**
   - 检查文件夹路径设置
   - 确认选择了正确的过滤器
   - 查看控制台输出确认API请求成功

### 调试方法

1. **查看控制台日志**
   ```javascript
   // 在Obsidian中按 Ctrl+Shift+I 打开开发者工具
   // 查看Console标签页的输出
   ```

2. **测试API端点**
   ```bash
   # 测试健康检查
   curl http://localhost:3001/health
   
   # 查看所有文章
   curl http://localhost:3001/api/debug/articles
   ```

3. **查看服务器日志**
   - Mock服务器会在终端显示所有API请求
   - 包含请求体和响应信息

## 🔄 切换回生产环境

要切换回使用真实的Omnivore API：

1. **重新构建插件**
   ```bash
   cd obsidian-plug/obsidian-omnivore
   # 不设置LOCAL_TEST环境变量
   npm run build
   ```

2. **或者修改代码**
   ```typescript
   // 在 src/build-config.ts 中设置
   const isLocalTest = false; // 改为 false
   ```

3. **重新复制文件到Obsidian**
   - 复制新生成的main.js文件
   - 重启Obsidian

## 📝 开发说明

### 代码结构
- `src/settings/local-test.ts` - 本地测试配置
- `src/build-config.ts` - 构建时配置
- `src/api.ts` - API调用重定向逻辑

### 扩展功能
- 在 `server/mockData.js` 中修改测试数据
- 在 `server/index.js` 中添加新的API端点
- 预留的DatabaseManager类可用于真实数据库集成

---

**🎉 现在你可以安全地在本地环境中测试Obsidian Omnivore插件的所有功能了！**